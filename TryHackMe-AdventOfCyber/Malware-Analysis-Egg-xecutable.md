# Malware Analysis Using Sandboxes - TryHackMe

> Static and dynamic malware analysis in safe environments

**Room Link:** https://tryhackme.com/room/malware-sandbox-aoc2025-SD1zn4fZQt

---

## Task 2: Malware Analysis Using Sandboxes

### Principles of Malware Analysis

**What is it?**
- Examining malicious files
- Understanding functionality
- Learning how to defend

**Why analyze?**
- Block attacker servers
- Find traces on machines
- Understand attacker techniques
- Proactive defense

### Analysis Types

**Static Analysis:**
- Inspect without execution
- No running the file
- Safer approach

**Dynamic Analysis:**
- Execute the file
- Observe behavior
- See actual actions

---

## Sandboxes

### What are Sandboxes?

**Definition:** Safe, isolated environments for dangerous code

**Think of it as:** Disposable digital play-pens

**Golden Rule:** Never run malware on devices you care about!

### Why Virtual Machines?

**Benefits:**
- Control system operations
- Snapshots (save/restore states)
- Complete isolation
- Safe testing environment

**Important:** Only run samples in isolated environments!

---

## Static Analysis

### SHA256 Hash

**Tool:** Get-FileHash (PowerShell) or similar

**Command:**
```powershell
Get-FileHash HopHelper.exe -Algorithm SHA256
```

**Q: SHA256Sum of HopHelper.exe?**

- Answer: `F29C270068F865EF4A747E2683BFA07667BF64E768B38FBB9A2750A3D879CA33`

---

### Strings Analysis

**Tool:** strings command

**Command:**
```bash
strings HopHelper.exe
```

Look towards the bottom of output for flags.

**Q: Flag with format THM{XXXXX} in strings?**

- Answer: `THM{STRINGS_FOUND}`

---

## Dynamic Analysis

### Registry Persistence

**Tool:** Registry Monitor or Process Monitor

Execute HopHelper.exe and monitor registry changes.

**Common persistence location:**
```
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```

**Q: Full path of registry key modified for persistence?**

- Answer: `HKU\S-1-5-21-1966530601-3185510712-10604624-1008\Software\Microsoft\Windows\CurrentVersion\Run\HopHelper`

---

### Network Communication

**Tool:** ProcMon (Process Monitor)

**Steps:**
1. Start ProcMon
2. Execute HopHelper.exe
3. Filter for "TCP" operations
4. Check protocol used

**Q: Network protocol used by HopHelper.exe?**

- Answer: `http`

---

## Quick Reference

### Static Analysis Tools

**Hash calculation:**
```powershell
Get-FileHash file.exe -Algorithm SHA256
certutil -hashfile file.exe SHA256
```

**Strings extraction:**
```bash
strings file.exe
strings file.exe | grep THM
```

**File info:**
```bash
file file.exe
```

### Dynamic Analysis Tools

**Windows:**
- Process Monitor (ProcMon)
- Registry Monitor (RegMon)
- Process Explorer
- Wireshark (network)

**Linux:**
- strace
- ltrace
- tcpdump

### Analysis Workflow

```
1. Static Analysis
   ↓
2. Calculate Hash
   ↓
3. Extract Strings
   ↓
4. Setup Sandbox
   ↓
5. Take Snapshot
   ↓
6. Dynamic Analysis
   ↓
7. Monitor Registry
   ↓
8. Monitor Network
   ↓
9. Restore Snapshot
```

### Registry Persistence Keys

**Common locations:**
```
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

**Detection:**
- Check Run keys
- Monitor modifications
- Compare before/after

### Network Analysis

**ProcMon filters:**
- Operation: TCP Connect
- Operation: TCP Send
- Operation: TCP Receive

**Indicators:**
- External IPs
- Suspicious ports
- HTTP/HTTPS traffic
- DNS queries

### Sandbox Best Practices

**Before execution:**
- Take snapshot
- Disable network (optional)
- Start monitoring tools
- Document baseline

**During execution:**
- Capture all changes
- Monitor registry
- Watch network
- Log file operations

**After execution:**
- Save logs
- Extract artifacts
- Restore snapshot
- Document findings

### Analysis Checklist

**Static:**
- [ ] Calculate file hash
- [ ] Extract strings
- [ ] Check file type
- [ ] Examine metadata
- [ ] Look for IOCs

**Dynamic:**
- [ ] Setup sandbox
- [ ] Start monitoring
- [ ] Execute sample
- [ ] Check registry
- [ ] Monitor network
- [ ] Capture artifacts
- [ ] Restore environment

### Common Artifacts

**Registry:**
- Run keys
- Services
- Scheduled tasks

**Files:**
- Dropped executables
- Configuration files
- Log files

**Network:**
- C2 servers
- Download URLs
- Exfiltration endpoints

---

## Key Takeaways

- **Static analysis** without execution
- **Dynamic analysis** with execution
- **Sandboxes** are safe environments
- **Golden rule** never run on real systems
- **Virtual machines** for isolation
- **Snapshots** save/restore states
- **SHA256** identifies files uniquely
- **Strings** reveal embedded data
- **Registry** persistence mechanism
- **Run keys** common autostart
- **ProcMon** monitors operations
- **TCP filters** show network activity
- **Always isolate** dangerous samples

Happy hunting!
