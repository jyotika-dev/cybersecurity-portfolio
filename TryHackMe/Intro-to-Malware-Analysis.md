# Intro to Malware Analysis - TryHackMe

> Learn the basics of malware analysis for SOC analysts

**Room Link:** https://tryhackme.com/room/intromalwareanalysis

<img width="1447" height="894" alt="image" src="https://github.com/user-attachments/assets/b819c66a-9af0-43f6-9f9d-48a99f304b2f" />


---

## Task 1: Introduction

**Recommended OS:**
- REMnux: Linux toolkit for malware analysis

**Safety Rules:**
- Analyze on isolated machines only
- Store samples in password-protected archives
- Use dedicated VMs with snapshots
- Disconnect internet during analysis
- Revert VM after each session

**No answer needed**

---

## Task 2: Malware Analysis

### What is Malware?

Software with malicious intent.

### Who Uses Malware Analysis?

**Security Operations:** Write detections

**Incident Response:** Determine damage

**Threat Hunt:** Identify IOCs

**Malware Researchers:** Add detections

**Threat Research:** Find vulnerabilities

### Questions

**Q1: Which team uses malware analysis to look for IOCs?**

Hunt for malware in networks.

- Answer: `Threat hunt team`

---

## Task 3: Techniques of Malware Analysis

### Analysis Categories

**Static Analysis:**
- Analyze without executing
- Check strings
- Examine PE headers
- Disassemble code

**Evasion:** Obfuscation, packing

**Dynamic Analysis:**
- Run in controlled environment
- Use VMs and sandboxes
- Observe behavior

**Evasion:** Environment detection

**Advanced Analysis:**
- Disassemblers (binary → assembly)
- Debuggers (monitor execution)

### Questions

**Q1: Technique for analyzing without executing?**

- Answer: `Static analysis`

---

**Q2: Technique for analyzing by executing and observing?**

- Answer: `Dynamic analysis`

---

## Task 4: Basic Static Analysis

### First Steps

"Size up" the malware before deep analysis.

### Basic Techniques

**File type:**
```bash
file <filename>
```

**Strings:**
```bash
strings <filename>
```

**Hashes:**
```bash
md5sum <filename>
sha256sum <filename>
```

**VirusTotal:**
Upload hash for reports.

### Questions

**Q1: MD5 hash of 'redline' sample?**

Location: `Desktop/Samples`

```bash
md5sum redline
```

- Answer: `ca2dc5a3f94c4f19334cc8b68f256259`

---

**Q2: Creation time of sample?**

Check PE metadata.

- Answer: `2020-08-01 02:44:18 UTC`

---

## Task 5: The PE File Header

### PE Header Info

**Imports/Exports:**
- Functions from external DLLs
- Reveals capabilities

**Sections:**
- `.text` - executable code
- `.data` - global variables
- `.rsrc` - resources (icons, images)

### Commands

**Check PE header:**
```bash
pecheck <malwarename>
```

**GUI tool:**
```bash
pe-tree <malwarename>
```

### Questions

**Q1: Entropy of .text section in 'redline'?**

- Answer: `6.453919`

---

**Q2: Name of fifth section in 'redline'?**

Four known: .text, .rdata, .data, .rsrc

- Answer: `.ndata`

---

**Q3: Which DLL imports RegOpenKeyExW function?**

Check imports table.

- Answer: `ADVAPI32.dll`

---

**Q4: Explore pe-tree tool.**

```bash
pe-tree redline
```

**No answer needed**

---

## Task 6: Basic Dynamic Analysis

### Sandbox Requirements

**Virtual Machine:** Mimic target environment

**Snapshotting:** Revert to clean state

**OS Monitoring:** Procmon, Regshot

**Network Monitoring:** Wireshark, tcpdump

**Controlled Network:** Dummy DNS/web servers

**Secure Transfer:** Move files safely

### Sandbox Options

**Open Source:**
- Cuckoo Sandbox (archived 2021)
- CAPE Sandbox (community version)

**Online:**
- Hybrid Analysis
- Any.run
- Intezer

### Questions

**Q1: First process launched by 'redline' on Hybrid Analysis?**

Check process tree in report.

- Answer: `setup_installer.exe`

---

**Q2: Two Windows utilities used by malware?**

Format: utility1.exe and utility2.exe

- Answer: `cmd.exe and powershell.exe`

---

## Task 7: Anti-Analysis Techniques

### Packing and Obfuscation

**Purpose:** Hinder static analysis

**Methods:**
- Encrypt malware
- Compress code
- Obscure strings

### Sandbox Evasion

**Long Sleep Calls:**
- Wait before activity
- Timeout sandbox

**User Activity Detection:**
- Check mouse/keyboard
- Detect automation patterns

**Footprinting:**
- Examine user files
- Check browsing history
- Verify real environment

**VM Detection:**
- Look for VM drivers
- Check for VM artifacts
- Terminate if VM found

### Questions

**Q1: Technique to bypass static analysis?**

- Answer: `packing`

---

**Q2: Technique to timeout a sandbox?**

- Answer: `long sleep calls`

---

## Task 8: Conclusion

**No answer needed**

---

## Quick Reference

### Analysis Types

| Type | Method | Tools |
|------|--------|-------|
| **Static** | Without execution | strings, pecheck |
| **Dynamic** | With execution | Sandbox, Procmon |
| **Advanced** | Deep dive | Debuggers, disassemblers |

### Basic Commands

```bash
# File info
file malware.exe

# Extract strings
strings malware.exe

# Calculate hashes
md5sum malware.exe
sha256sum malware.exe

# PE analysis
pecheck malware.exe
pe-tree malware.exe
```

### PE Sections

- **.text** - code execution
- **.data** - variables
- **.rsrc** - resources
- **.rdata** - read-only data
- **.ndata** - custom data

### Sandbox Setup

```
VM + Snapshot
    ↓
Monitoring Tools
    ↓
Controlled Network
    ↓
Execute Malware
    ↓
Analyze Behavior
    ↓
Revert Snapshot
```

### Evasion Techniques

**Against Static:**
- Packing
- Obfuscation
- Encryption

**Against Dynamic:**
- Long sleep calls
- User activity checks
- VM detection
- Footprinting
  
---

## Key Takeaways

- **Analyze safely** in isolated VMs
- **Threat hunters** look for IOCs
- **Static analysis** without execution
- **Dynamic analysis** observes behavior
- **PE headers** reveal functionality
- **Strings** show capabilities
- **Hashes** identify samples
- **Entropy** indicates packing
- **Imports** reveal DLL functions
- **Sandboxes** automate analysis
- **Process trees** show execution flow
- **Packing** defeats static analysis
- **Long sleeps** timeout sandboxes
- **Always revert** VM after analysis

Analyze safely, analyze smart!

Happy hunting!
